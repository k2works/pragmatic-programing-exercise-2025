# 開発日誌

## 日付: 2025年6月12日

### レンタルビデオアプリケーションのデータ構造とフォーマット機能のリファクタリング

今日はレンタルビデオアプリケーションのコード構造改善に取り組みました。主に明細書生成ロジックをデータ構造とフォーマット処理に分離し、テストの改善と拡張性の向上に注力しました。

#### 実装した機能

1. **データ構造を活用した明細書生成**:
   - 明細書データを中間データ構造として生成する機能
   - 顧客名、映画リスト、合計金額、獲得ポイントを構造化
   - テストとフォーマット処理の分離による保守性向上

2. **明細書フォーマット機能の実装**:
   - データ構造から文字列形式の明細書を生成する機能
   - 映画タイトルと料金を整形して表示
   - 合計金額と獲得ポイントの表示

3. **テスト改善**:
   - データ構造の検証とフォーマット出力の検証を分離
   - 単体テストの強化
   - 統合テストの追加

4. **コード構造の改善**:
   - 関心の分離によるコードの整理
   - 将来の拡張性を考慮した設計
   - テスト駆動開発の継続的な適用

#### 実装コード

```clojure
;; データ構造を生成する関数
(defn make-statement-data [rental-order]
  (let [{:keys [name]} (:customer rental-order)
        {:keys [rentals]} rental-order]
    {:customer-name name
     :movies (for [rental rentals]
             {:title (:title (:movie rental))
              :price (determine-amount rental)})
     :owed (reduce + (map determine-amount rentals))
     :points (reduce + (map determine-points rentals))}))

;; 明細書フォーマット関数
(defn format-rental-statement [statement-data]
  (let [customer-name (:customer-name statement-data)
        movies (:movies statement-data)
        owed (:owed statement-data)
        points (:points statement-data)]
    (str
      (format "Rental Record for %s\n" customer-name)
      (apply str
             (for [movie movies]
               (format "\t%s\t%.1f\n"
                       (:title movie) (:price movie))))
      (format "You owed %.1f\n" owed)
      (format "You earned %d frequent renter points\n" points))))

;; 既存の明細書生成関数（参考）
(defn make-statement [rental-order]
  (let [{:keys [name]} (:customer rental-order)
        {:keys [rentals]} rental-order
        header (format "Rental Record for %s\n" name)
        details (clojure.string/join "\n" (make-details rentals))
        footer (make-footer rentals)]
    (str header details footer)))
```

#### テスト実装

```clojure
;; データ構造生成のテスト
(deftest rental-store-calculation-test
  (testing "makes statement for a single new release"
    (let [customer (make-customer "Fred")]
      (is (= {:customer-name "Fred"
              :movies [{:title "The Cell" :price 9.0}]
              :owed 9.0
              :points 2}
             (make-statement-data
               (make-rental-order
                 customer
                 [(make-rental
                    (make-movie "The Cell" :new-release)
                    3)]))))))

  (testing "makes statement for several regular movies"
    (let [customer (make-customer "Fred")]
      (is (= {:customer-name "Fred"
              :movies [{:title "Plan 9 from Outer Space" :price 2.0}
                       {:title "8 1/2" :price 2.0}
                       {:title "Eraserhead" :price 3.5}]
              :owed 7.5
              :points 3}
               (make-statement-data
                 (make-rental-order
                   customer
                   [(make-rental
                      (make-movie "Plan 9 from Outer Space" :regular)
                      1)
                    (make-rental
                      (make-movie "8 1/2" :regular)
                      2)
                    (make-rental
                      (make-movie "Eraserhead" :regular)
                      3)])))))))

;; フォーマット機能のテスト
(deftest rental-statement-format-test
  (testing "Formats a rental statement"
    (is (= (str "Rental Record for CUSTOMER\n"
                  "\tMOVIE\t9.9\n"
                  "You owed 100.0\n"
                  "You earned 99 frequent renter points\n")
             (format-rental-statement
               {:customer-name "CUSTOMER"
                :movies [{:title "MOVIE" :price 9.9}]
                :owed 100.0
                :points 99})))))

;; 統合テスト
(deftest integration-test
  (testing "formats a statement for several regular movies"
    (is (= (str "Rental Record for Fred\n"
                  "\tPlan 9 from Outer Space\t2.0\n"
                  "\t8 1/2\t2.0\n"
                  "\tEraserhead\t3.5\n"
                  "You owed 7.5\n"
                  "You earned 3 frequent renter points\n")
             (format-rental-statement
               (make-statement-data
                 (make-rental-order
                   (make-customer "Fred")
                   [(make-rental
                      (make-movie "Plan 9 from Outer Space" :regular)
                      1)
                    (make-rental
                      (make-movie "8 1/2" :regular)
                      2)
                    (make-rental
                      (make-movie "Eraserhead" :regular)
                      3)])))))))
```

#### 次のステップ

1. HTML形式での明細書出力機能の追加
2. 顧客情報の管理機能の拡張
3. レンタル履歴の保存と検索機能の実装
4. 在庫管理機能の実装
5. 多言語対応（日本語、英語など）

#### 所感

今回の実装では、明細書生成ロジックをデータ構造の生成とフォーマット処理に分離することで、コードの保守性と拡張性を向上させました。関数型プログラミングの特性を活かして、データの変換と表示を明確に分離することができました。特に、`make-statement-data`関数でデータ構造を生成し、`format-rental-statement`関数でそれを表示用に整形する設計により、将来的に新しい出力形式（例：HTML、PDF、JSON）を追加する際にも容易に拡張できる基盤ができました。

テスト駆動開発のアプローチを継続して採用し、各機能に対応するテストケースを先に作成することで、要件を明確にしながら実装を進めることができました。特にデータ構造の検証とフォーマット出力の検証を分離したことで、テストの意図が明確になり、バグの発見や修正が容易になりました。

また、統合テストを追加することで、データ生成からフォーマット処理までの一連の流れが正しく機能することを確認できるようになりました。これにより、個々のコンポーネントが正しく動作するだけでなく、それらが連携して期待通りの結果を生成することを保証できます。

次のステップとしては、HTML形式での明細書出力機能の追加や、顧客情報の管理機能の拡張に取り組む予定です。今回のリファクタリングにより、これらの機能追加がより容易になったと考えています。
