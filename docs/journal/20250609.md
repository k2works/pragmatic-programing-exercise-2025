# 開発日誌

## 日付: 2025年6月9日

### レンタルビデオアプリケーションの機能拡張

今日はレンタルビデオアプリケーションの機能拡張作業を行いました。主に料金計算ロジックの改善と、レンタル明細書の生成機能の修正に取り組みました。

#### 実装した機能

1. **映画カテゴリに応じた料金計算の拡張**:
   - 既存の新作（:new-release）カテゴリに加えて、以下のカテゴリを追加
   - 一般作品（:regular）: 基本料金2.0、3日以上で追加料金1.5/日
   - 子供向け（:childrens）: 基本料金1.5、5日以上で追加料金1.0/日
   - クラシック（:classic）: 固定料金1.0（レンタル日数に関係なく）

2. **レンタルポイント計算ロジックの改善**:
   - 新作を2日以上レンタルした場合は2ポイント付与（既存の仕様）
   - クラシック作品は追加で1ポイント付与する仕様を追加
   - 一般作品と子供向け作品は基本の1ポイントのまま

3. **明細書生成機能の修正**:
   - 各レンタル項目の詳細（タイトル、日数、料金）を表示するよう修正
   - 合計金額の計算ロジックを修正
   - フォーマットの調整

#### 実装コード

```clojure
;; 料金計算関数の拡張
(defn calculate-rental-fee [rental]
  (let [movie (:movie rental)
        days (:days rental)
        category (:category movie)]
    (case category
      :new-release (* 3.0 days)
      :regular (if (< days 3)
                 2.0
                 (+ 2.0 (* 1.5 (- days 2))))
      :childrens (if (< days 5)
                   1.5
                   (+ 1.5 (* 1.0 (- days 4))))
      :classic 1.0
      0.0)))  ;; 未知のカテゴリの場合

;; レンタルポイント計算関数
(defn calculate-rental-points [rental]
  (let [movie (:movie rental)
        days (:days rental)
        category (:category movie)
        base-points 1]
    (cond
      (and (= category :new-release) (> days 1)) (+ base-points 1)
      (= category :classic) (+ base-points 1)
      :else base-points)))

;; 明細書生成関数の修正
(defn make-statement [rental-order]
  (let [customer (:customer rental-order)
        rentals (:rentals rental-order)
        customer-name (:name customer)
        rental-details (map (fn [rental]
                             (let [movie (:movie rental)
                                   title (:title movie)
                                   days (:days rental)
                                   fee (calculate-rental-fee rental)]
                               (str "\t" title "\t" days "日\t" fee)))
                           rentals)
        rental-fees (map calculate-rental-fee rentals)
        total-fee (reduce + rental-fees)
        frequent-renter-points (reduce + (map calculate-rental-points rentals))]
    (str "Rental Record for " customer-name "\n"
         (clojure.string/join "\n" rental-details) "\n"
         "Amount owed is " total-fee "\n"
         "You earned " frequent-renter-points " frequent renter points\n")))
```

#### テスト実装

新しい機能に対応するテストケースも追加しました：

```clojure
(deftest rental-fee-calculation-test
  (testing "calculates correct fee for different movie categories"
    (let [new-release-movie (create-movie "新作映画" :new-release)
          regular-movie (create-movie "一般映画" :regular)
          childrens-movie (create-movie "子供向け映画" :childrens)
          classic-movie (create-movie "クラシック映画" :classic)]
      
      ;; 新作映画のテスト
      (is (= 6.0 (calculate-rental-fee (make-rental new-release-movie 2))))
      (is (= 9.0 (calculate-rental-fee (make-rental new-release-movie 3))))
      
      ;; 一般映画のテスト
      (is (= 2.0 (calculate-rental-fee (make-rental regular-movie 2))))
      (is (= 3.5 (calculate-rental-fee (make-rental regular-movie 3))))
      (is (= 5.0 (calculate-rental-fee (make-rental regular-movie 4))))
      
      ;; 子供向け映画のテスト
      (is (= 1.5 (calculate-rental-fee (make-rental childrens-movie 3))))
      (is (= 1.5 (calculate-rental-fee (make-rental childrens-movie 4))))
      (is (= 2.5 (calculate-rental-fee (make-rental childrens-movie 5))))
      
      ;; クラシック映画のテスト
      (is (= 1.0 (calculate-rental-fee (make-rental classic-movie 1))))
      (is (= 1.0 (calculate-rental-fee (make-rental classic-movie 10)))))))

(deftest rental-points-calculation-test
  (testing "calculates correct rental points for different movie categories"
    (let [new-release-movie (create-movie "新作映画" :new-release)
          regular-movie (create-movie "一般映画" :regular)
          childrens-movie (create-movie "子供向け映画" :childrens)
          classic-movie (create-movie "クラシック映画" :classic)]
      
      ;; 新作映画のポイントテスト
      (is (= 1 (calculate-rental-points (make-rental new-release-movie 1))))
      (is (= 2 (calculate-rental-points (make-rental new-release-movie 2))))
      
      ;; 一般映画のポイントテスト
      (is (= 1 (calculate-rental-points (make-rental regular-movie 1))))
      (is (= 1 (calculate-rental-points (make-rental regular-movie 5))))
      
      ;; 子供向け映画のポイントテスト
      (is (= 1 (calculate-rental-points (make-rental childrens-movie 1))))
      (is (= 1 (calculate-rental-points (make-rental childrens-movie 5))))
      
      ;; クラシック映画のポイントテスト
      (is (= 2 (calculate-rental-points (make-rental classic-movie 1))))
      (is (= 2 (calculate-rental-points (make-rental classic-movie 5)))))))
```

#### 次のステップ

1. 顧客情報の管理機能の拡張
2. レンタル履歴の保存と検索機能の実装
3. HTML形式の明細書出力機能の追加
4. 在庫管理機能の実装

#### 所感

今回の実装では、映画のカテゴリに応じた料金計算とポイント付与の仕組みを拡張しました。Clojureの関数型プログラミングの特性を活かして、条件分岐を明確に表現することができました。特に`case`や`cond`などの条件分岐構文を使うことで、ビジネスロジックを読みやすく実装できたと思います。

また、明細書の生成機能も改善し、より詳細な情報を提供できるようになりました。今後は、これらの基本機能を土台にして、より高度な機能（顧客管理、在庫管理など）を実装していく予定です。

テスト駆動開発のアプローチを取ることで、各機能の正確性を確保しながら開発を進めることができました。特に料金計算のような複雑なビジネスロジックは、テストケースを先に書くことで要件を明確にし、実装の方向性を定めることができました。