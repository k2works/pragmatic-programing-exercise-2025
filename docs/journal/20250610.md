# 開発日誌

## 日付: 2025年6月10日

### レンタルビデオアプリケーションのテスト拡充とリファクタリング

今日はレンタルビデオアプリケーションのテスト拡充とコードのリファクタリングを行いました。主に複数の映画カテゴリに対応した料金計算ロジックの実装とテストケースの追加に取り組みました。

#### 実装した機能

1. **複数映画カテゴリの料金計算**:
   - 新作映画（:new-release）: 1日あたり3.0の料金
   - 子供向け映画（:childrens）: 3日以内は1.5、それ以上は追加料金1.5/日
   - 一般映画（:regular）: 2日以内は2.0、それ以上は追加料金1.5/日

2. **レンタルポイント計算の実装**:
   - 基本は1ポイント
   - 新作映画を2日以上レンタルした場合は2ポイント

3. **明細書生成機能の改善**:
   - 複数の映画レンタルに対応
   - 動的に映画タイトルと料金を表示
   - 合計金額とポイントの計算を正確に実装

4. **コードのリファクタリング**:
   - 冗長な関数の削除
   - ヘルパー関数の導入による可読性の向上
   - 命名の統一と改善

#### 実装コード

```clojure
;; 料金計算関数
(defn determine-amount [rental]
  (let [{:keys [movie days]} rental
        type (:type movie)]
    (condp = type
      :regular
      (if (> days 2)
        (+ 2.0 (* (- days 2) 1.5))
        2.0)

      :new-release
      (* 3.0 days)

      :childrens
      (if (> days 3)
        (+ 1.5 (* (- days 3) 1.5))
        1.5))))

;; ポイント計算関数
(defn determine-points [rental]
  (let [{:keys [movie days]} rental
        type (:type movie)]
    (if (and (= type :new-release)
      (> days 1))
    2
    1)))

;; 明細行生成関数
(defn make-detail [rental]
  (let [title (:title (:movie rental))
        price (determine-amount rental)]
    (format "\t%s\t%.1f" title price)))

;; 明細一覧生成関数
(defn make-details [rentals]
  (map make-detail rentals))

;; フッター生成関数
(defn make-footer [rentals]
  (let [owed (reduce + (map determine-amount rentals))
        points (reduce + (map determine-points rentals))]
    (format
      "\nYou owed %.1f\nYou earned %d frequent renter points\n"
      owed points)))

;; 明細書生成関数
(defn make-statement [rental-order]
  (let [{:keys [name]} (:customer rental-order)
        {:keys [rentals]} rental-order
        header (format "Rental Record for %s\n" name)
        details (clojure.string/join "\n" (make-details rentals))
        footer (make-footer rentals)]
    (str header details footer)))
```

#### テスト実装

各機能に対応するテストケースも追加しました：

```clojure
;; 新作映画のテスト
(deftest new-release-test
  (testing "新作映画の料金とポイント計算"
    (let [movie (make-movie "The Cell" :new-release)
          rental (make-rental movie 3)
          amount (determine-amount rental)
          points (determine-points rental)]
      (is (= 9.0 amount))
      (is (= 2 points)))))

;; 子供向け映画のテスト
(deftest childrens-movie-test
  (testing "子供向け映画の料金計算"
    (let [movie (make-movie "The Tigger Movie" :childrens)]
      ;; 3日以内の場合
      (let [rental (make-rental movie 3)
            amount (determine-amount rental)]
        (is (= 1.5 amount)))
      ;; 3日を超える場合
      (let [rental (make-rental movie 5)
            amount (determine-amount rental)]
        (is (= 4.5 amount))))))

;; 一般映画のテスト
(deftest regular-movie-test
  (testing "一般映画の料金計算"
    (let [movie (make-movie "Plan 9 from Outer Space" :regular)]
      ;; 2日以内の場合
      (let [rental (make-rental movie 2)
            amount (determine-amount rental)]
        (is (= 2.0 amount)))
      ;; 2日を超える場合
      (let [rental (make-rental movie 4)
            amount (determine-amount rental)]
        (is (= 5.0 amount))))))

;; 明細書生成のテスト
(deftest statement-test
  (testing "複数映画の明細書生成"
    (let [customer (make-customer "Fred")
          new-release (make-movie "The Cell" :new-release)
          childrens (make-movie "The Tigger Movie" :childrens)
          regular (make-movie "Plan 9 from Outer Space" :regular)
          rentals [(make-rental new-release 3)
                   (make-rental childrens 3)
                   (make-rental regular 2)]
          order (make-rental-order customer rentals)
          statement (make-statement order)]
      (is (string? statement))
      (is (.contains statement "Fred"))
      (is (.contains statement "The Cell"))
      (is (.contains statement "The Tigger Movie"))
      (is (.contains statement "Plan 9 from Outer Space")))))
```

#### 次のステップ

1. HTML形式の明細書出力機能の追加
2. 顧客情報の管理機能の拡張
3. レンタル履歴の保存と検索機能の実装
4. 在庫管理機能の実装

#### 所感

今回の実装では、テスト駆動開発のアプローチを取りながら、レンタルビデオアプリケーションの基本機能を拡充しました。特に、異なる映画カテゴリに対応した料金計算ロジックを実装し、それぞれのケースに対するテストを追加することで、機能の正確性を確保できました。

コードのリファクタリングにより、関数の責務が明確になり、可読性と保守性が向上しました。特に、明細書生成のロジックを複数の小さな関数に分割したことで、各部分の役割が明確になり、将来的な機能拡張がしやすくなったと思います。

また、テストケースを充実させることで、今後の機能追加や修正の際にも、既存機能の正常動作を保証できる基盤ができました。次のステップとしては、昨日の日誌で挙げていたHTML形式の明細書出力機能の実装に取り組む予定です。
